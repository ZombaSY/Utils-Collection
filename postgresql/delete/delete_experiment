CREATE OR REPLACE FUNCTION public.delete_experiment(
	arg_account_index INTEGER,
	arg_workspace_index INTEGER,
	arg_project_index INTEGER,
	arg_experiment_index INTEGER,
	ignore_permission BOOLEAN)
    RETURNS TABLE(
        tb_code INTEGER,
        tb_container_name TEXT,
        tb_cloud_path TEXT)
    LANGUAGE 'plpgsql'

    COST 100
    VOLATILE

AS $BODY$
DECLARE
    v_record RECORD;
    v_experiment_index INTEGER;
    v_project_name TEXT;
    v_experiment_name TEXT;
    v_container_name TEXT;
    v_cloud_paths TEXT;
    v_deleted_blob_sizes BIGINT := 0;
    v_loop_counter INTEGER := 0;
    check_query INTEGER;
BEGIN

    ------------------------- Called from external function -------------------------
    IF ignore_permission = FALSE THEN

        -- Check has permission --
        check_query :=
            (SELECT id FROM public.experiment
                WHERE public.experiment.id = arg_experiment_index AND creator = arg_account_index);

        IF check_query IS NOT NULL THEN

            -- Delete experiment --
            DELETE FROM public.experiment
                WHERE id = arg_experiment_index
                RETURNING id INTO v_experiment_index;

            IF v_experiment_index IS NULL THEN
                tb_code := -1;  -- No row deleted --
                RETURN NEXT;
            END IF;

            -- Get names to delete azure cloud blobs --
            SELECT public.experiment.name,
                   public.project.name,
                   cloud_container_name
                   FROM public.experiment
                INNER JOIN public.project ON
                    public.experiment.belonged_project_id = public.project.id
                INNER JOIN public.azure_cloud_container ON
                    public.project.belonged_workspace_id = public.azure_cloud_container.workspace_id
                WHERE public.experiment.id = arg_experiment_index AND
                      public.project.id = arg_project_index AND
                      public.azure_cloud_container.workspace_id = arg_workspace_index
                INTO v_experiment_name, v_project_name, v_container_name;

            -- @@@@@@@@@@@@@@@@@@@@@ azure blob 구조 바꾸기. path 형태에서 column 에 종속되게

            -- 구조 바뀌면 지울 때 다르게 지워야됨
            -- Delete blob referencing deleted experiment --
            FOR v_record IN
                DELETE FROM public.azure_cloud_blob
                    WHERE container_name = v_container_name AND
                          cloud_path LIKE v_project_name || '/' || v_experiment_name || '%'
                    RETURNING cloud_path, blob_size
            LOOP

            IF v_loop_counter = 0 THEN
                v_cloud_paths := v_record.cloud_path;
            ELSE
                v_cloud_paths := v_cloud_paths || ',' || v_record.cloud_path;
            END IF;

            v_deleted_blob_sizes := v_deleted_blob_sizes + v_record.blob_size;
            v_loop_counter := v_loop_counter + 1;
            END LOOP;

            -- Update container left usage --
            UPDATE public.azure_cloud_container
                SET storage_usage = storage_usage - v_deleted_blob_sizes
                WHERE cloud_container_name = v_container_name;


            -- Returning blob cloud paths to remove real blobs in azure cloud server --
            tb_code := 0;
            tb_cloud_path := v_cloud_paths;
            tb_container_name := v_container_name;
            RETURN NEXT;
        ELSE
            tb_code := -100;    -- Permission denied --
            RETURN NEXT;
        END IF;

    ------------------------- Called from internal function -------------------------
    ELSE

        -- Release account from project --
        DELETE FROM public.ref_account_project
            WHERE id_project = arg_project_index;

        -- Delete experiment --
        DELETE FROM public.experiment
            WHERE id = arg_experiment_index
            RETURNING id INTO v_experiment_index;

        IF v_experiment_index IS NULL THEN
            tb_code := -1;  -- No row deleted --
            RETURN NEXT;
        END IF;


        SELECT public.experiment.name,
               public.project.name,
               cloud_container_name
               FROM public.experiment
            INNER JOIN public.project ON
                public.experiment.belonged_project_id = public.project.id
            INNER JOIN public.azure_cloud_container ON
                public.project.belonged_workspace_id = public.azure_cloud_container.workspace_id
            WHERE public.experiment.id = arg_experiment_index AND
                  public.project.id = arg_project_index AND
                  public.azure_cloud_container.workspace_id = arg_workspace_index
            INTO v_experiment_name, v_project_name, v_container_name;


        -- Delete blob referencing deleted experiment --
        FOR v_record IN
            DELETE FROM public.azure_cloud_blob
                WHERE container_name = v_container_name AND
                      cloud_path LIKE v_project_name || '/' || v_experiment_name || '%'
                RETURNING cloud_path, blob_size
        LOOP

        IF v_loop_counter = 0 THEN
            v_cloud_paths := v_record.cloud_path;
        ELSE
            v_cloud_paths := v_cloud_paths || ',' || v_record.cloud_path;
        END IF;

        v_deleted_blob_sizes := v_deleted_blob_sizes + v_record.blob_size;
        v_loop_counter := v_loop_counter + 1;
        END LOOP;

        -- Update container left usage --
        UPDATE public.azure_cloud_container
            SET storage_usage = storage_usage - v_deleted_blob_sizes
            WHERE cloud_container_name = v_container_name;


        -- Returning blob cloud paths to remove real blobs in azure cloud server --
        tb_code := 0;
        tb_cloud_path := v_cloud_paths;
        tb_container_name := v_container_name;
        RETURN NEXT;
    END IF;
END;
$BODY$;
